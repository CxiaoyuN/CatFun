name: iOS Debug 打包（Flutter 适配）

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装 Flutter 环境
        uses: subosito/flutter-action@v2
        with:
          flutter-version: latest-stable  # 匹配项目使用的 Flutter 版本，如 3.16.0
          channel: stable

      - name: 配置 Xcode 版本
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Flutter 依赖安装 & 生成 iOS 配置文件
        run: |
          # 进入 Flutter 根目录（关键：不是 ios 子目录！）
          # 若仓库根目录就是 Flutter 工程，直接执行；否则调整 cd 路径
          flutter pub get  # 生成 pubspec.lock 并拉取 Dart 依赖
          flutter precache ios  # 预下载 iOS 相关编译资源（可选，加速构建）
          # 生成 iOS 侧的 Generated.xcconfig 文件
          cd ios && flutter build ios --config-only  # 仅生成配置，不完整编译

      - name: 安装 iOS 依赖（CocoaPods）
        run: |
          cd ios  # 进入 iOS 子目录
          pod install --repo-update  # 此时 Generated.xcconfig 已存在，可正常执行

      - name: 构建并打包 IPA
        run: |
          cd ios
          # 清理缓存
          xcodebuild clean -workspace ${{ secrets.XCODE_WORKSPACE }} -scheme ${{ secrets.XCODE_SCHEME }} -configuration Debug
          # 归档 + 导出 IPA
          xcodebuild archive -workspace ${{ secrets.XCODE_WORKSPACE }} -scheme ${{ secrets.XCODE_SCHEME }} -configuration Debug -archivePath ./build/CatFun.xcarchive
          xcodebuild -exportArchive -archivePath ./build/CatFun.xcarchive -exportPath ./build/ipa -exportOptionsPlist ./ExportOptions.plist

      - name: 上传 IPA 产物
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-ipa
          path: ios/build/ipa/*.ipa
          retention-days: 7
